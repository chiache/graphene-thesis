\subsection{Stream I/O}
\label{sec:abi:streams}


The host ABI abstracts all I/O devices as byte streams to send data in and out of the applications.
Modern OSes often contain several out-of-band or asynchronous I/O abstractions, to improve the latency or CPU occupancy when polling on I/O devices.
Although using out-of-band or asynchronous I/O is beneficial for application performance, the implementation of these I/O features can be challenging for many hosts.
Therefore, the host ABI used by \graphene{} only implements the basic, synchronous, byte-stream I/O,
with differentiation between normal stream I/O and server I/O (e.g., a listening TCP socket).  

\subsubsection*{Opening or creating a stream}


\begin{paldef}
HANDLE StreamOpen (const char *stream_uri,
                   uint access_flags, uint share_flags,
                   uint create_flags, uint options);
\end{paldef}


\palkeyword{StreamOpen} can open an existing I/O stream, or create a new I/O stream.
The usage of \palkeyword{StreamOpen} is similar to \syscall{open} in POSIX,
but instead of using file paths to locate I/O stream resources, \palkeyword{StreamOpen} uses URIs (uniform resource identifiers) to identify both I/O stream types and locations (as given in the argument \palkeyword{stream_uri}).
The IO stream types can be determined by the {\rm prefixes} of URIs, which can be one of the following options:

\begin{compactitem}
\item \palkeyword{file:[path]}: A regular file mapped from the host file system. The file is located by a file path on the host. The file path can be either an absolute path from the root the host file system, or a relative path from the current working directory on the host.
\item \palkeyword{tcp:[address]:[port]} or \palkeyword{udp:[address]:[port]}: A TCP or UDP connection to a remote socket, identified by a IPv4 or IPv6 address and a listening port. The TCP connection exists until it is teared down by the both parties.
\item \palkeyword{tcp.srv:[address]:[port]} or \palkeyword{udp.srv:[address]:[port]}: A TCP or UDP server waiting for remote connections, bound on a IPv4 or IPv6 address and an idle port.
\item \palkeyword{pipe:}:
\item \palkeyword{pipe.srv:}:
\end{compactitem}

\palkeyword{access_flags} can be any combination of the following access types:
\begin{compactitem}
\item \palkeyword{ACCESS_R}:
\item \palkeyword{ACCESS_W}:
\item \palkeyword{ACCESS_X}:
\end{compactitem}


\palkeyword{share_flags} can be any combination of the following sharing types:
\begin{compactitem}
\item \palkeyword{SHARE_R}:
\item \palkeyword{SHARE_W}:
\item \palkeyword{SHARE_X}:
\end{compactitem}


\palkeyword{create_flags} can be any combination of the following two conditions:
\begin{compactitem}
\item \palkeyword{CREATE_TRY}:
\item \palkeyword{CREATE_ALWAYS}:
\end{compactitem}



\subsubsection*{Reading and writing a stream}

\begin{paldef}
ulong StreamRead (HANDLE stream_handle,
                  ulong offset, ulong size, void *buffer,
                  char *source_uri, uint uri_len);
ulong StreamWrite (HANDLE stream_handle,
                   ulong offset, ulong size,
                   const void *buffer,
                   const char *dest_uri);
\end{paldef}


\subsubsection*{Mapping a stream into virtual memory}

\begin{paldef}
void *StreamMap (HANDLE stream_handle, void *addr,
                 uint prot, ulong offset, ulong size);
\end{paldef}



\subsubsection*{Querying stream attributes}

\begin{paldef}
bool StreamAttrQuery (const char *stream_uri,
                      STREAM_ATTRS attributes);
bool StreamAttrQuerybyHandle (HANDLE stream_handle,
                              STREAM_ATTRS attributes);
\end{paldef}



\subsubsection*{Setting stream lengths and attributes}


\begin{paldef}
bool StreamSetLength (HANDLE stream_handle,
                      ulong length);
\end{paldef}


\begin{paldef}
bool StreamAttrSetbyHandle (HANDLE stream_handle,
                            STREAM_ATTRS attributes);
\end{paldef}




\subsubsection*{Flushing a stream}


\begin{paldef}
bool StreamFlush (HANDLE stream_handle);
\end{paldef}


\subsection*{Waiting for a listening stream}


\begin{paldef}
HANDLE StreamWaitforClient (HANDLE stream_handle);
\end{paldef} 


\subsubsection*{Deleting or shutting down a stream}


\begin{paldef}
HANDLE StreamDelete (HANDLE stream_handle,
                     uint delete_flags);
\end{paldef}